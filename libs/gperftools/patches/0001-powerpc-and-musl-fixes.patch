From de51cdf0c1c346f97137da0fc7a453f2ff5faa45 Mon Sep 17 00:00:00 2001
From: Josef Schlehofer <pepe.schlehofer@gmail.com>
Date: Tue, 23 Sep 2025 18:35:30 +0200
Subject: [PATCH 1/3] powerpc: include <asm/ptrace.h> for PT_NIP declaration

This patch conditionally includes <asm/ptrace.h> when available to
ensure PT_NIP is properly declared, fixing build failures such as:

  error: 'PT_NIP' was not declared in this scope; did you mean 'PT_NUM'?

It happened on musl and powerpc
---
 src/stacktrace_powerpc-linux-inl.h | 3 +++
 1 file changed, 3 insertions(+)

--- a/src/stacktrace_powerpc-linux-inl.h
+++ b/src/stacktrace_powerpc-linux-inl.h
@@ -48,6 +48,9 @@
 #include <gperftools/stacktrace.h>
 #include <base/vdso_support.h>
 
+#ifdef HAVE_ASM_PTRACE_H
+#include <asm/ptrace.h>
+#endif
 #if HAVE_SYS_UCONTEXT_H
 #include <sys/ucontext.h>
 #elif HAVE_UCONTEXT_H
@@ -204,7 +207,11 @@ static int GET_STACK_TRACE_OR_FRAMES {
           ucontext_t uc;
           // We don't care about the rest, since IP value is at 'uc' field.A
         } *sigframe = reinterpret_cast<rt_signal_frame_32*>(current);
+        #if defined(__GLIBC__)
         result[n] = (void*) sigframe->uc.uc_mcontext.uc_regs->gregs[PT_NIP];
+        #else
+        result[n] = (void*) sigframe->uc.uc_mcontext.gregs[PT_NIP];
+        #endif
       }
 #endif
 
--- a/src/base/elf_mem_image.cc
+++ b/src/base/elf_mem_image.cc
@@ -39,6 +39,7 @@
 #ifdef HAVE_ELF_MEM_IMAGE  // defined in elf_mem_image.h
 
 #include <stddef.h>   // for size_t, ptrdiff_t
+#include <sys/reg.h> // for musl's WORDSIZE
 #include "base/logging.h"
 
 // From binutils/include/elf/common.h (this doesn't appear to be documented
