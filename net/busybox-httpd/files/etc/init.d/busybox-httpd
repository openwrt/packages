#!/bin/sh /etc/rc.common
# Copyright (C) 2025 OpenWrt.org
START=51
USE_PROCD=1

validate_section_httpd() {
	uci_load_validate httpd httpd "$1" "$2" \
		'enabled:bool:1' \
		'port:port:80' \
		'home:directory:/www' \
		'realm:string' \
		'c_file:file'
}

start_httpd_instance() {
	[ "$2" = 0 ] || {
		echo "validation failed"
		return 1
	}
	[ "$enabled" = 0 ] && return 1
	local cfg="$1"
	procd_open_instance "$cfg"
	procd_set_param respawn
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param command /usr/sbin/httpd -f
	procd_append_param command -p "$port"
	procd_append_param command -h "$home"
	[ -z "$realm" ] && realm="$(cat /proc/sys/kernel/hostname)"
	procd_append_param command -r "$realm"
	[ -n "$c_file" ] && procd_append_param command -c "$c_file"
	procd_close_instance
}

start_service()
{
	config_load httpd
	config_foreach validate_section_httpd httpd start_httpd_instance
}
